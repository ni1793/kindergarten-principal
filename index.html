<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¹¼ç¨šåœ’åœ’é•·å®ˆå‰‡</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Creepster&family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        /* --- åŸºç¤è¨­å®š (ç¬¬å…­ç‰ˆæ’ç‰ˆ - å°ºå¯¸å„ªåŒ–) --- */
        :root {
            --bg-color: #FDF5E6; 
            --text-color: #1a1a1a;
            --box-bg: rgba(255, 255, 255, 0.98); 
            --accent-color: #3e2723;
            --npc-bg: #EFEFEF; 
            --system-text: #555;
            --border-light: #CCCCCC; 
            --border-dark: #888888; 
            --qte-color: #D32F2F; 

            /* äººç‰©åç¨±æ·±è‰²è®Šé‡ */
            --npc-color-kobayashi: #8B0000; 
            --npc-color-children: #4B0082; 
            --npc-color-chef: #8B4513;     
            --npc-color-oldprincipal: #36454F; 
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Noto Sans TC', "Microsoft JhengHei", "PingFang TC", sans-serif; /* ä¸»è¦ä¸­æ–‡å’Œç³»çµ±å­—é«” */
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 1.5s ease, color 1.5s ease;
            height: 100vh;
            min-height: 100vh; /* ç¢ºä¿æœ€å°é«˜åº¦ç‚ºè¦–çª—é«˜åº¦ */
            display: flex;
            justify-content: center;
            align-items: center;
            overflow-x: hidden; /* åªéš±è—æ°´å¹³æº¢å‡º */
            font-size: 15px;
            box-sizing: border-box;
        }

        #game-container {
            width: 100%;
            max-width: 600px;
            height: 100%;
            max-height: 100vh; /* æ‰‹æ©Ÿä¸Šï¼Œæœ€å¤§é«˜åº¦é™åˆ¶ç‚ºè¦–çª—é«˜åº¦ */
            background: var(--box-bg);
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 15px rgba(0,0,0,0.2); 
            position: relative;
            border-radius: 0;
            margin: 5px; /* ç‚ºæ‰‹æ©Ÿé‚Šç·£ç•™å‡ºé–“éš™ */
            box-sizing: border-box;
            overflow: hidden; /* ç¢ºä¿å…§å®¹ä¸æœƒæº¢å‡ºå®¹å™¨ */
        }

        @media (min-width: 601px) {
            #game-container {
                height: 90vh; /* é›»è…¦ç‰ˆç¶­æŒ 90vh */
                border: 1px solid var(--border-dark);
                margin: 0; /* é›»è…¦ç‰ˆç§»é™¤é–“éš™ */
                border-radius: 8px; /* é›»è…¦ç‰ˆå¢åŠ åœ“è§’ */
            }
        }

        header {
            padding: 15px;
            text-align: center;
            border-bottom: 1px solid var(--border-light);
            font-family: 'Creepster', cursive; /* æ¨™é¡Œä½¿ç”¨ææ€–å­—é«” */
            font-weight: 400; /* Creepster å­—é«”æ¬Šé‡è¨­å®š */
            font-size: 1.8rem; /* å¢å¤§æ¨™é¡Œå­—é«” */
            color: var(--accent-color);
            letter-spacing: 2px; /* å¢åŠ å­—è· */
            text-transform: uppercase;
            background-color: var(--box-bg); /* ç¢ºä¿æ¨™é¡ŒèƒŒæ™¯èˆ‡å®¹å™¨ä¸€è‡´ */
        }
        
        /* --- äººç‰©åç¨±é¡è‰²è¨­å®š --- */
        .npc::before {
            content: attr(data-sender);
            position: absolute;
            top: -24px;
            left: 0;
            font-size: 0.85rem;
            font-weight: 700;
            background: var(--bg-color); 
            padding: 0 8px; /* å¢åŠ å…§é‚Šè· */
            border: 1px solid var(--border-light);
            box-shadow: 1px 1px 0 var(--border-light);
            border-radius: 4px; /* åœ“è§’ */
            z-index: 2;
        }
        
        /* ä¾è§’è‰²åˆ†é…é¡è‰² */
        .npc.kobayashi::before { color: var(--npc-color-kobayashi); }
        .npc.children::before { color: var(--npc-color-children); }
        .npc.chef::before { color: var(--npc-color-chef); }
        .npc.oldprincipal::before { color: var(--npc-color-oldprincipal); }
        .npc:not(.kobayashi):not(.children):not(.chef):not(.oldprincipal)::before { color: var(--text-color); }

        /* --- å…§å®¹å€åŸŸè¨­å®š --- */
        #log-area {
            flex: 1;
            padding: 25px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px; 
            scroll-behavior: smooth;
            background-image: repeating-linear-gradient(0deg, transparent, transparent 19px, rgba(0,0,0,0.01) 20px);
        }

        .message {
            max-width: 85%;
            padding: 12px 16px;
            border: 1px solid var(--border-light);
            line-height: 1.7; 
            animation: fadeIn 0.4s ease-out;
            position: relative;
            word-wrap: break-word;
            font-size: 0.95rem; 
            box-shadow: 2px 2px 8px rgba(0,0,0,0.1); /* æ›´æŸ”å’Œçš„é™°å½± */
            border-radius: 8px; /* åœ“è§’ */
            transition: transform 0.2s ease-out, box-shadow 0.2s ease-out;
        }

        .message:hover {
            transform: translateY(-2px); /* è¼•å¾®ä¸Šæµ®æ•ˆæœ */
            box-shadow: 3px 3px 10px rgba(0,0,0,0.15);
        }

        .system {
            align-self: center;
            background: transparent;
            border: none;
            box-shadow: none;
            font-style: italic;
            color: var(--system-text);
            text-align: center;
            font-size: 0.9rem;
            border-top: 1px solid rgba(0,0,0,0.05);
            border-bottom: 1px solid rgba(0,0,0,0.05);
            padding: 8px 0;
            margin: 8px 0;
            border-radius: 0; /* ç³»çµ±è¨Šæ¯ä¸åŠ åœ“è§’ */
        }

        .npc {
            align-self: flex-start;
            background: var(--npc-bg);
            color: #000;
            margin-top: 25px;
            margin-left: 5px;
            border-bottom-left-radius: 0; /* NPCè¨Šæ¯å·¦ä¸‹è§’å°–è§’ */
        }

        .player {
            align-self: flex-end;
            background: var(--accent-color);
            color: #fff;
            border: 1px solid var(--accent-color);
            margin-right: 5px;
            border-bottom-right-radius: 0; /* ç©å®¶è¨Šæ¯å³ä¸‹è§’å°–è§’ */
        }

        #controls-area {
            padding: 20px;
            background: #fff;
            border-top: 1px solid var(--border-dark);
            display: flex;
            flex-direction: column;
            gap: 12px; /* å¢åŠ æŒ‰éˆ•é–“è· */
            min-height: 140px;
            justify-content: center;
            background-color: var(--box-bg); /* èˆ‡ä¸»å®¹å™¨èƒŒæ™¯ä¿æŒä¸€è‡´ */
        }

        button {
            padding: 14px 18px; /* å¢åŠ æŒ‰éˆ•é»æ“Šå€åŸŸ */
            border: 1px solid var(--border-dark);
            border-radius: 6px; /* è¼•å¾®åœ“è§’ */
            background: #fff;
            font-family: 'Noto Sans TC', sans-serif;
            font-size: 0.95rem; /* ç¨å¾®å¢å¤§å­—é«” */
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease; /* æ›´æµæš¢çš„éæ¸¡ */
            box-shadow: 2px 2px 0px rgba(0,0,0,0.08);
            color: #000;
            text-align: left;
            position: relative; /* ç‚ºäº†å¯èƒ½æ·»åŠ çš„è£é£¾ */
        }
        
        button:hover {
            background-color: var(--accent-color); /* Hover æ™‚è®Šè‰² */
            color: #fff;
            transform: translateY(-2px);
            box-shadow: 3px 3px 6px rgba(0,0,0,0.15);
            border-color: var(--accent-color);
        }

        button:active {
            transform: translateY(0);
            box-shadow: 1px 1px 3px rgba(0,0,0,0.1);
        }

        /* --- éŸ³é‡æ§åˆ¶æŒ‰éˆ• --- */
        #volume-control {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 40px;
            height: 40px;
            border-radius: 50%; /* åœ“å½¢æŒ‰éˆ• */
            background-color: rgba(0, 0, 0, 0.6); /* åŠé€æ˜æ·±è‰² */
            color: #fff;
            border: none;
            font-size: 1.2rem;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            z-index: 10;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            transition: background-color 0.2s ease;
            padding: 0; /* ç§»é™¤é è¨­ padding */
            line-height: 1; /* ç¢ºä¿åœ–æ¨™å‚ç›´å±…ä¸­ */
        }

        #volume-control:hover {
            background-color: rgba(0, 0, 0, 0.8);
            transform: scale(1.05);
        }

        #volume-icon {
            line-height: 1;
        }

        /* QTE è¦–è¦ºæ•ˆæœ */
        #qte-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.95); /* æ›´æ·±è‰²çš„èƒŒæ™¯ */ display: none; flex-direction: column; justify-content: center; align-items: center; color: white; z-index: 50; }
        #qte-prompt { 
            font-family: 'Noto Sans TC', sans-serif; /* QTE æç¤ºä¹Ÿç”¨æ–°å­—é«” */
            font-size: 2.2rem; /* ç¨å¾®å¢å¤§ */
            margin-bottom: 20px; 
            color: var(--qte-color); 
            text-shadow: 0 0 15px rgba(255, 0, 0, 0.7); /* æ›´æ˜é¡¯çš„é™°å½± */
            animation: pulseText 1s infinite alternate; /* æ–°çš„æ–‡æœ¬è„ˆè¡å‹•ç•« */
        }
        #qte-key { 
            font-family: 'Creepster', cursive; /* QTE æŒ‰éµç”¨ææ€–å­—é«” */
            font-size: 6.5rem; 
            font-weight: bold; 
            border: 4px solid var(--qte-color); 
            padding: 10px 30px; 
            border-radius: 8px; /* è¼•å¾®åœ“è§’ */
            animation: pulse 0.7s infinite alternate, shake 0.5s infinite; /* çµåˆè„ˆè¡å’Œè¼•å¾®æ™ƒå‹• */
            background: rgba(255, 255, 255, 0.15); /* è¼•å¾®èƒŒæ™¯è‰² */
            box-shadow: 0 0 20px rgba(255, 0, 0, 0.6);
        }
        #qte-timer { margin-top: 25px; width: 220px; height: 12px; background: #555; border-radius: 6px; overflow: hidden; box-shadow: inset 0 0 5px rgba(0,0,0,0.5); }
        #qte-bar { height: 100%; background: linear-gradient(to right, var(--qte-color), #FF5722); /* æ¼¸å±¤æ¢ */ width: 100%; transition: width linear; }
        @keyframes pulse { from { transform: scale(1); opacity: 1; } to { transform: scale(1.08); opacity: 0.9; } }
        @keyframes pulseText { from { text-shadow: 0 0 10px rgba(255, 0, 0, 0.5); } to { text-shadow: 0 0 20px rgba(255, 0, 0, 0.9); } }
        @keyframes shake {
            0% { transform: translateX(0); }
            25% { transform: translateX(-2px) translateY(-1px) rotate(0.5deg); }
            50% { transform: translateX(2px) translateY(1px) rotate(-0.5deg); }
            75% { transform: translateX(-1px) translateY(2px) rotate(0.5deg); }
            100% { transform: translateX(0); }
        }

        .text-red { color: #D32F2F !important; font-weight: bold; } /* ä½¿ç”¨ QTE ç´…è‰² */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- ä¿®æ­£çš„èµ·å§‹ç•«é¢ CSS --- */
        #start-screen {
            position: fixed; 
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #000; 
            color: #fff;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            z-index: 100; 
            cursor: pointer;
            transition: opacity 1s ease;
            padding: 20px;
            box-sizing: border-box; /* ç¢ºä¿ padding ä¸æœƒå°è‡´æº¢å‡º */
        }

        #start-screen h1 {
            font-family: 'Creepster', cursive; /* æ¨™é¡Œä½¿ç”¨ææ€–å­—é«” */
            font-size: 3.5rem; /* å¢å¤§æ¨™é¡Œå­—é«” */
            margin-bottom: 15px;
            letter-spacing: 3px;
            color: #FFD700; 
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.6); /* æ›´å¼·çƒˆçš„æ–‡å­—é™°å½± */
            width: 100%; 
            max-width: 90%; /* é™åˆ¶æœ€å¤§å¯¬åº¦ï¼Œé¿å…éå¯¬ */
            animation: pulseText 2s infinite alternate; /* è®“æ¨™é¡Œæœ‰è„ˆè¡æ•ˆæœ */
        }

        #start-screen p {
            font-family: 'Noto Sans TC', sans-serif;
            font-size: 1.2rem; /* ç¨å¾®å¢å¤§æ®µè½å­—é«” */
            margin-top: 15px;
            color: #CCC; /* ç¨å¾®äº®ä¸€äº›çš„ç°è‰² */
            width: 100%; 
            max-width: 90%; /* é™åˆ¶æœ€å¤§å¯¬åº¦ */
            line-height: 1.6;
        }

        #start-screen p:last-child {
            font-size: 1rem;
            color: #AAA;
            margin-top: 30px;
        }

        /* æ·±è‰²æ¨¡å¼èª¿æ•´ */
        body[data-theme='dark'] {
            --text-color: #EEE;
            --box-bg: rgba(20, 20, 20, 0.95);
            --border-light: #555;
            --border-dark: #777;
            --system-text: #AAA;
            --accent-color: #8b0000; /* æ·±è‰²æ¨¡å¼å¼·èª¿è‰² */
            --npc-bg: #333; /* æ·±è‰²æ¨¡å¼ NPC è¨Šæ¯èƒŒæ™¯ */
        }

        body[data-theme='dark'] header {
            color: var(--accent-color);
            border-bottom-color: var(--border-dark);
            background-color: var(--box-bg);
        }

        body[data-theme='dark'] .npc::before {
            background: var(--box-bg);
            border-color: var(--border-dark);
            box-shadow: 1px 1px 0 var(--border-dark);
        }

        body[data-theme='dark'] .message {
            border-color: var(--border-dark);
            box-shadow: 2px 2px 8px rgba(0,0,0,0.4);
        }

        body[data-theme='dark'] .player {
            background: var(--accent-color);
            border-color: var(--accent-color);
        }
        
        body[data-theme='dark'] #controls-area {
            background: var(--box-bg);
            border-top-color: var(--border-dark);
        }

        body[data-theme='dark'] button {
            background: #444;
            color: #EEE;
            border-color: #666;
            box-shadow: 2px 2px 0px rgba(0,0,0,0.3);
        }

        body[data-theme='dark'] button:hover {
            background-color: var(--accent-color);
            border-color: var(--accent-color);
            color: #fff;
        }

    </style>
</head>
<body data-theme="light">
    
<audio id="bgm-player" loop></audio>
<audio id="sfx-player"></audio>

<div id="game-container">
    <header id="header-title">å¹¼ç¨šåœ’åœ’é•·å®ˆå‰‡</header>
    
    <button id="volume-control">
        <span id="volume-icon">ğŸ”Š</span> 
    </button>
    
    <div id="log-area"></div>
    <div id="controls-area"></div>

    <div id="qte-overlay">
        <div id="qte-prompt">ğŸš¨ ç·Šæ€¥æ‡‰è®Š ğŸš¨</div> <div id="qte-key"></div>
        <div id="qte-timer">
            <div id="qte-bar"></div>
        </div>
    </div>
</div>

<div id="start-screen">
    <h1>å¹¼ç¨šåœ’åœ’é•·å®ˆå‰‡</h1>
    <p>é»æ“Šä»»æ„è™•é–‹å§‹éŠæˆ²ä¸¦æ’­æ”¾éŸ³æ¨‚</p>
    <br><br>
    <p style="font-size: 0.9rem; border: none; animation: none;">(å»ºè­°ä½©æˆ´è€³æ©Ÿï¼ŒéŸ³æ•ˆå·²é–‹å•Ÿ)</p>
</div>

<script>
    // --- éŠæˆ²ç‹€æ…‹ ---
    let gameState = {
        hasRuleBook: false,
        hasKitchenKey: false, // å„²è—å®¤é‘°åŒ™ (ç”Ÿé½çš„é‘°åŒ™)
        hasLibraryCode: false,
        hasLockerKey: false,   // å…’ç«¥å„²ç‰©æ«ƒé‘°åŒ™
        hasTapeRecorder: false,
        hasCrowbar: false,     // éµæ’¬
        hasMapFragment: false, // åœ°åœ–ç¢ç‰‡
        hasCabinetKey: false,  // æ–°å¢ï¼šæª”æ¡ˆæ«ƒé‘°åŒ™
        sanity: 100
    };

    function resetGame() {
        gameState = { 
            hasRuleBook: false, hasKitchenKey: false, hasLibraryCode: false, 
            hasLockerKey: false, hasTapeRecorder: false, hasCrowbar: false, 
            hasMapFragment: false, hasCabinetKey: false, sanity: 100 
        };
        logArea.innerHTML = '';
        currentBGM = null;
    }

    // --- è£ç½®åµæ¸¬èˆ‡éŸ³æ•ˆæ§åˆ¶ (èˆ‡å…ˆå‰ç‰ˆæœ¬ä¿æŒä¸€è‡´) ---
    const bgmPlayer = document.getElementById('bgm-player');
    const sfxPlayer = document.getElementById('sfx-player');
    const volumeIcon = document.getElementById('volume-icon');
    const volumeControl = document.getElementById('volume-control');
    let isMuted = false; 
    let currentBGM = null;
    
    // åµæ¸¬æ˜¯å¦ç‚ºè§¸æ§è£ç½® (æ‰‹æ©Ÿ/å¹³æ¿)
    function isTouchDevice() {
        return ('ontouchstart' in window) || 
               (navigator.maxTouchPoints > 0) || 
               (navigator.msMaxTouchPoints > 0);
    }
    const isMobile = isTouchDevice();

    function playBGM(src, volume = 0.4) {
        if (currentBGM === src) return;
        bgmPlayer.pause();
        bgmPlayer.src = src;
        bgmPlayer.volume = volume;
        currentBGM = src;
        if (!isMuted) {
            bgmPlayer.play().catch(e => console.warn("BGM play failed."));
        }
    }

    function stopBGM() {
        bgmPlayer.pause();
        currentBGM = null;
    }

    function playSFX(src, volume = 0.8) {
        sfxPlayer.src = src;
        sfxPlayer.volume = volume;
        if (!isMuted) {
            sfxPlayer.play().catch(e => console.warn("SFX play failed:"));
        }
    }

    function toggleMute() {
        isMuted = !isMuted;
        if (isMuted) {
            bgmPlayer.pause();
            sfxPlayer.volume = 0;
            volumeIcon.textContent = 'ğŸ”‡';
        } else {
            if (currentBGM) {
                bgmPlayer.play().catch(e => console.warn("BGM play failed after unmute:"));
            }
            sfxPlayer.volume = 0.8; 
            volumeIcon.textContent = 'ğŸ”Š';
        }
    }
    volumeControl.onclick = toggleMute;

    // --- QTE æ ¸å¿ƒé‚è¼¯ (èˆ‡å…ˆå‰ç‰ˆæœ¬ä¿æŒä¸€è‡´) ---
    const qteOverlay = document.getElementById('qte-overlay');
    const qteKeyDisplay = document.getElementById('qte-key');
    const qteBar = document.getElementById('qte-bar');
    const qtePrompt = document.getElementById('qte-prompt'); 
    let qteTimeout = null;
    let qteKeyListener = null;
    let qteTapListener = null;

    function endQTE() {
        qteOverlay.style.display = 'none';
        qteBar.style.transitionDuration = '0ms'; 
        // ç¢ºä¿æ¸…ç†æ‰€æœ‰ç›£è½å™¨
        if (qteKeyListener) {
            document.removeEventListener('keydown', qteKeyListener);
            qteKeyListener = null;
        }
        if (qteTapListener) {
            qteOverlay.removeEventListener('touchstart', qteTapListener);
            qteTapListener = null;
        }
    }

    function startQTE(targetKey, duration, successScene, failScene, promptText) {
        endQTE(); // å•Ÿå‹•å‰å…ˆæ¸…ç†ï¼Œç¢ºä¿æ²’æœ‰æ®˜ç•™çš„ç›£è½å™¨
        
        qteOverlay.style.display = 'flex';
        controlsArea.innerHTML = ''; 

        // ä½¿ç”¨ã€Œç·Šæ€¥æ‡‰è®Šã€ä½œç‚ºé è¨­æç¤ºï¼Œé™¤éæœ‰æä¾›è‡ªå®šç¾©æ–‡æœ¬
        qtePrompt.textContent = promptText || 'ğŸš¨ ç·Šæ€¥æ‡‰è®Š ğŸš¨';

        qteBar.style.width = '100%';
        qteBar.style.transitionDuration = `${duration}ms`;

        setTimeout(() => {
            qteBar.style.width = '0%';
        }, 50);

        // è¨­å®šæ™‚é–“åˆ°æœŸå¤±æ•—
        qteTimeout = setTimeout(() => {
            endQTE();
            renderScene(failScene);
        }, duration);

        if (isMobile) {
            // --- æ‰‹æ©Ÿï¼šå¿«é€Ÿé»æ“Šæ¨¡å¼ ---
            const tapGoal = 10; // éœ€è¦é»æ“Šçš„æ¬¡æ•¸
            let tapCount = 0;
            
            qteKeyDisplay.textContent = 'TAP x' + tapGoal;
            
            qteTapListener = (event) => {
                event.preventDefault(); // é˜²æ­¢ç§»å‹•ç«¯é è¨­è¡Œç‚ºï¼Œä¾‹å¦‚ç¸®æ”¾
                tapCount++;
                qteKeyDisplay.textContent = 'TAP x' + (tapGoal - tapCount);
                
                if (tapCount >= tapGoal) {
                    clearTimeout(qteTimeout);
                    endQTE();
                    renderScene(successScene);
                }
            };
            qteOverlay.addEventListener('touchstart', qteTapListener);

        } else {
            // --- é›»è…¦ï¼šéµç›¤æŒ‰éµæ¨¡å¼ ---
            qteKeyDisplay.textContent = targetKey.toUpperCase();

            qteKeyListener = (event) => {
                const key = event.key.toUpperCase();
                // æˆåŠŸåˆ¤å®š
                if (key === targetKey.toUpperCase()) {
                    clearTimeout(qteTimeout);
                    endQTE();
                    renderScene(successScene);
                // å¤±æ•—åˆ¤å®šï¼šæŒ‰äº†å…¶ä»– QTE ç›¸é—œçš„éµ
                } else if (['A', 'D', 'W', 'S', 'J', 'K', 'L'].includes(key)) {
                    clearTimeout(qteTimeout);
                    endQTE();
                    renderScene(failScene);
                }
            };
            document.addEventListener('keydown', qteKeyListener);
        }
    }

    // --- æ•…äº‹è…³æœ¬ ---
    const story = {
        start: {
            bg: "#FDF5E6", title: "åºç« ï¼šç•°è®Š", clearScreen: true,
            messages: [
                { sender: "system", text: "ä½ æ„Ÿè¦ºå–‰åš¨è£¡åƒæ˜¯å¡æ»¿äº†æ£‰èŠ±ï¼Œå‘¼å¸å›°é›£ã€‚" },
                { sender: "system", text: "çœé–‹çœ¼ï¼Œé€™æ˜¯ä¸€å€‹å……æ»¿éœ‰å‘³çš„è¾¦å…¬å®¤ã€‚ç‰†ä¸Šçš„æ™‚é˜å€’è‘—èµ°ã€‚" },
                { sender: "npc", name: "é–€å¤–çš„è²éŸ³", class: "kobayashi", text: "åœ’é•·... å˜»å˜»... åœ’é•·é†’äº†å—ï¼Ÿ" },
                { sender: "player", text: "ï¼ˆé ­å¥½ç—›... æ¡Œä¸Šé€™å¼µç´™å¯«è‘—ä»€éº¼ï¼Ÿï¼‰" },
                { sender: "system", text: "ä¸€å¼µæ²¾è‘—æš—è¤è‰²æ±¡æ¼¬çš„ç´™æ¢è¢«é‡˜åœ¨æ¡Œä¸Šã€‚" }
            ],
            choices: [
                { text: "æŸ¥çœ‹ç´™æ¢å…§å®¹", next: "read_note" },
                { text: "ä¸ç†æœƒï¼Œç›´æ¥å›æ‡‰é–€å¤–çš„äºº", next: "ignore_note" }
            ]
        },
        read_note: {
            bg: "#ECEFF1",
            messages: [
                { sender: "system", text: "å­—è·¡éå¸¸ç”¨åŠ›ï¼Œç”šè‡³åŠƒç ´äº†ç´™å¼µï¼š" },
                { sender: "system", text: "1. é€™è£¡ä¸æ˜¯å¹¼å…’åœ’ï¼Œæ˜¯<span class='text-red'>é£¼è‚²å ´</span>ã€‚\n2. å­©å­å€‘åªåƒç´…è‰²çš„è‚‰ã€‚\n3. å¦‚æœè½åˆ°ç¬‘è²ï¼Œ<span class='text-red'>ä¸è¦å›é ­</span>ã€‚\n4. <span class='text-red'>æ•´å€‹å¹¼ç¨šåœ’çš„é¡å­éƒ½ä¸èƒ½ç›´è¦–</span>ã€‚" },
                { sender: "player", text: "ï¼ˆé£¼è‚²å ´...ï¼Ÿé¡å­... é€™è£¡åˆ°åº•æ˜¯ä»€éº¼é¬¼åœ°æ–¹ï¼Ÿï¼‰" }
            ],
            effect: () => { gameState.hasRuleBook = true; }, 
            choices: [{ text: "å°‡ç´™æ¢æ‰çˆ›åé€²è‚šå­ (éŠ·æ¯€è­‰æ“š)", next: "office_investigate" }]
        },
        ignore_note: {
            bg: "#FDF5E6",
            messages: [
                { sender: "player", text: "ã€Œä¸ç®¡äº†ï¼Œå¤§æ¦‚æ˜¯èª°çš„æƒ¡ä½œåŠ‡ã€‚ã€" },
                { sender: "system", text: "ä½ å‰›ç«™èµ·èº«ï¼Œç´™æ¢çªç„¶ç„¡ç«è‡ªç‡ƒï¼ŒåŒ–ç‚ºç°ç‡¼ã€‚" }
            ],
            choices: [{ text: "åœ¨åŠ©æ‰‹é€²ä¾†å‰ï¼Œå…ˆèª¿æŸ¥è¾¦å…¬å®¤", next: "office_investigate" }]
        },
        
        office_investigate: {
            bg: "#FDF5E6",
            messages: [
                { sender: "system", text: "é–€å¤–çš„è²éŸ³å®‰éœä¸‹ä¾†äº†ã€‚é€™æ˜¯æ‚¨å”¯ä¸€çš„æ©Ÿæœƒã€‚æ ¡é•·è¾¦å…¬å®¤å…§å¾ˆäº‚ã€‚" }
            ],
            choices: [
                { text: "æª¢æŸ¥æ¡Œå­çš„æŠ½å±œ", next: "find_tape_recorder" },
                { text: "æª¢æŸ¥æª”æ¡ˆæ«ƒ", next: "check_filing_cabinet" }, 
                { text: "çœ‹å‘è¾¦å…¬å®¤ç‰†ä¸Šçš„é¡å­", next: "bad_end_office_mirror" }, 
                { text: "ç›´æ¥é–‹é–€é¢å°é–€å¤–çš„åŠ©æ‰‹", next: "meet_assistant_door" }
            ]
        },

        find_tape_recorder: {
            bg: "#FDF5E6",
            effect: () => { gameState.hasTapeRecorder = true; },
            messages: [
                { sender: "system", text: "æ‚¨åœ¨æŠ½å±œæ·±è™•ç™¼ç¾ä¸€å€‹è€èˆŠçš„éŒ„éŸ³æ©Ÿã€‚ä¸Šé¢æ²¾æ»¿äº†æš—ç´…è‰²çš„æ²¹æ¼¬ã€‚" },
                { sender: "system", text: "éŒ„éŸ³æ©Ÿæ—æœ‰ä¸€å¼µç´™æ¢ï¼šã€ä¸è¦è®“ä»–å€‘è½åˆ°ã€‚ã€" }
            ],
            choices: [
                { text: "æ’­æ”¾éŒ„éŸ³å¸¶", next: "listen_to_tape" },
                { text: "ä»”ç´°æœç´¢æŠ½å±œçš„åº•éƒ¨", next: "search_drawer_thoroughly" } 
            ]
        },
        // ä»”ç´°æœç´¢æŠ½å±œ
        search_drawer_thoroughly: {
            bg: "#FDF5E6",
            effect: () => { gameState.hasCabinetKey = true; },
            messages: [
                { sender: "system", text: "ä½ åœ¨æŠ½å±œçš„è§’è½æ‘¸åˆ°ä¸€å€‹å†°å†·çš„é‡‘å±¬ç‰©ã€‚é€™æ˜¯ä¸€æŠŠ<span class='text-red'>æª”æ¡ˆæ«ƒé‘°åŒ™</span>ã€‚" }
            ]
            ,
            choices: [
                { text: "å°‡é‘°åŒ™è—å¥½ï¼Œè¿”å›èª¿æŸ¥è¾¦å…¬å®¤", next: "office_investigate" }, 
                { text: "å°‡é‘°åŒ™è—å¥½ï¼Œç›´æ¥é–‹é–€é¢å°åŠ©æ‰‹", next: "meet_assistant_door" }
            ]
        },


        listen_to_tape: {
            bg: "#1a1a1a", sfx: 'sfx_tension.mp3', textColor: "#FFF",
            messages: [
                { sender: "system", text: "ï¼ˆæ²™æ²™è²... å°–éŠ³çš„å–˜æ°£è²ï¼‰" },
                { sender: "npc", name: "å‰ä»»åœ’é•·", class: "oldprincipal", text: "ï¼ˆå¾®å¼±çš„ç”·è²ï¼‰å®ƒ... å®ƒå€‘éœ€è¦... éœ€è¦çš„æ˜¯ææ‡¼... çµ•å°ä¸èƒ½éœ²å‡ºç ´ç¶»... é£Ÿç‰©... é£Ÿç‰©æ˜¯ææ‡¼...ï¼ˆæ»‹â€”â€”æ»‹â€”â€”ï¼‰" },
                { sender: "system", text: "éŒ„éŸ³æ©Ÿç™¼å‡ºå°–éŠ³çš„é›œéŸ³å¾Œåœæ­¢äº†ã€‚ä½ æ„Ÿè¦ºèƒŒå¾Œä¸€é™£ç™¼æ¶¼ã€‚" }
            ],
            choices: [{ text: "é®å®šä¸‹ä¾†ï¼Œé–‹é–€é¢å°é–€å¤–çš„åŠ©æ‰‹", next: "meet_assistant_door" }]
        },
        
        // æª¢æŸ¥æª”æ¡ˆæ«ƒé‚è¼¯
        check_filing_cabinet: {
            messages: [],
            effect: () => {
                if (gameState.hasCabinetKey) {
                    renderScene('unlock_cabinet');
                } else {
                    renderScene('cabinet_locked');
                }
            },
            choices: []
        },
        cabinet_locked: {
            bg: "#FDF5E6",
            messages: [
                { sender: "system", text: "æª”æ¡ˆæ«ƒé–å¾—éå¸¸ç·Šï¼Œéœ€è¦ä¸€æŠŠç‰¹æ®Šçš„é‘°åŒ™ã€‚" }
            ],
            choices: [
                { text: "è¿”å›èª¿æŸ¥", next: "office_investigate" },
                { text: "ç›´æ¥é–‹é–€é¢å°é–€å¤–çš„åŠ©æ‰‹", next: "meet_assistant_door" }
            ]
        },
        // è§£é–æª”æ¡ˆæ«ƒ
        unlock_cabinet: {
            bg: "#FDF5E6",
            effect: () => { gameState.hasLibraryCode = true; }, // ç›´æ¥çµ¦äºˆé€ƒç”Ÿå¯†ç¢¼
            messages: [
                { sender: "system", text: "ä½ ç”¨é‘°åŒ™æ‰“é–‹äº†æª”æ¡ˆæ«ƒï¼Œè£¡é¢åªæœ‰ä¸€ä»½æ–‡ä»¶ï¼Œæ¨™é¡Œå¯«è‘—ï¼šã€äºŒåäºŒè™Ÿå¯¦é©—é«”ï¼šè™•ç†ç´€éŒ„ã€" },
                { sender: "system", text: "æ–‡ä»¶åº•éƒ¨æœ‰ä¸€ä¸²è¢«ç´…ç­†åœˆèµ·ä¾†çš„æ•¸å­—ï¼š<span class='text-red'>22</span>ã€‚" },
                { sender: "system", text: "ã€ç·šç´¢ï¼šé€ƒç”Ÿå¯†ç¢¼ 22 å·²ç²å¾—ï¼ã€‘" }
            ],
            choices: [
                { text: "å°‡æ–‡ä»¶éŠ·æ¯€ï¼Œé–‹é–€é¢å°åŠ©æ‰‹", next: "meet_assistant_door" }
            ]
        },
        
        meet_assistant_door: {
            bg: "#CFD8DC",
            messages: [
                { sender: "system", text: "ä½ æ‰“é–‹é–€ã€‚ä¸€å€‹ç©¿è‘—ç²‰è‰²åœè£™çš„å¥³äººç«™åœ¨é‚£è£¡ã€‚" },
                { sender: "npc", name: "åŠ©æ‰‹å°æ—", class: "kobayashi", text: "åœ’é•·æ—©å®‰ã€‚æ‚¨çš„è‡‰è‰²ä¸éŒ¯ï¼Œçœ‹èµ·ä¾†... å¾ˆæœ‰ç‡Ÿé¤Šã€‚" },
                { sender: "system", text: "å¥¹çš„è„–å­ä»¥ä¸€ç¨®ä¸è‡ªç„¶çš„éŠ³è§’æ­ªæ–œè‘—ï¼Œçœ¼ç™½éƒ¨åˆ†ä½ˆæ»¿äº†é»‘è‰²çš„è¡€çµ²ã€‚" },
                { sender: "player", text: "ï¼ˆé®å®š... å¥¹åœ¨è§€å¯Ÿæˆ‘ã€‚ï¼‰" }
            ],
            choices: [
                { text: "å¼·å‹¢è¦æ±‚ï¼šã€Œå¸¶æˆ‘å»è¦‹å­©å­å€‘ã€‚ã€", next: "classroom_scene" },
                { text: "å®³æ€•å¾—èº«é«”åƒµç¡¬", next: "bad_end_panic" } 
            ]
        },

        // --- Chapter 1 ---
        classroom_scene: {
            bg: "#546E7A", 
            // BGM æ²¿ç”¨åºç«  'bgm_mystery.mp3'
            clearScreen: true, title: "ç¬¬ä¸€ç« ï¼šè©­ç•°ç«¥è¬ ",
            messages: [
                { sender: "system", text: "æ•™å®¤è£¡åªæœ‰é–ƒçˆçš„æ—¥å…‰ç‡ˆã€‚" },
                { sender: "npc", name: "å­©å­å€‘", class: "children", text: "ï¼ˆé½Šè²ä½åŸï¼‰åœ’é•·ä¾†äº†... åœ’é•·ä¾†äº†... çš®è„†è‚‰å«©çš„åœ’é•·ä¾†äº†..." },
                { sender: "system", text: "ä»–å€‘æ…¢æ…¢è½‰éèº«ï¼Œè‡‰ä¸Šåªæœ‰ä¸€å¼µå·¨å¤§çš„å˜´ã€‚" }
            ],
            choices: [
                { text: "å¼·è£é®å®šï¼šã€Œç¾åœ¨æ˜¯å”±æ­Œæ™‚é–“ï¼ã€", next: "singing_time" },
                { text: "é¡«æŠ–è‘—è©¢å•ï¼šã€Œä½ å€‘... é¤“äº†å—ï¼Ÿã€", next: "bad_end_early_feed" } 
            ]
        },
        singing_time: {
            bg: "#37474F", textColor: "#FFF",
            messages: [
                { sender: "player", text: "ã€Œé å‚™... èµ·ï¼ã€" },
                { sender: "system", text: "å­©å­å€‘ç™¼å‡ºå°–éŠ³çš„å™ªéŸ³ï¼Œä½ ç·Šå’¬ç‰™é—œã€‚" },
                { sender: "npc", name: "åŠ©æ‰‹å°æ—", class: "kobayashi", text: "å¾ˆå¥½ï¼Œåœ’é•·ç¸½æ˜¯é€™éº¼æœ‰æ´»åŠ›ã€‚æˆ‘å»æº–å‚™é¤å…·ã€‚" }
            ],
            choices: [{ text: "è¶å°æ—é›¢é–‹æ™‚ï¼Œè§€å¯Ÿæ•™å®¤", next: "distraction_time" }]
        },
        
        distraction_time: {
            bg: "#3E2723", textColor: "#FFF",
            messages: [
                { sender: "system", text: "å™ªéŸ³æ˜¯æœ€å¥½çš„æ©è­·ã€‚" },
                { sender: "system", text: "ä½ æ³¨æ„åˆ°è¬›å°ä¸‹çš„é›œç‰©å †è£¡ï¼Œæœ‰ä¸€æŠŠ**ç”Ÿé½çš„é‘°åŒ™**ï¼Œå¯èƒ½æ˜¯å…’ç«¥å„²ç‰©æ«ƒçš„ã€‚" }
            ],
            choices: [
                { text: "å¿«é€Ÿå½è…°æ’¿èµ·é‘°åŒ™", next: "get_locker_key" },
                { text: "ä¿æŒç«™ç«‹ä¸å‹•", next: "stay_still" }
            ]
        },
        get_locker_key: {
            bg: "#3E2723",
            effect: () => { gameState.hasLockerKey = true; }, 
            messages: [
                { sender: "system", text: "ä½ æˆåŠŸæ‹¿åˆ°äº†é‘°åŒ™ã€‚å®ƒå¾ˆå°ï¼Œæ˜¯å…’ç«¥å„²ç‰©æ«ƒçš„é‘°åŒ™ã€‚" }
            ],
            choices: [{ text: "å‰å¾€å»šæˆ¿æº–å‚™åˆé¤", next: "lunch_prep" }]
        },
        stay_still: {
            bg: "#3E2723",
            messages: [
                { sender: "system", text: "ä½ æ±ºå®šå°‡å®‰å…¨æ”¾åœ¨ç¬¬ä¸€ä½ï¼Œæ²’æœ‰å»ç¢°é‚£å€‹å¯ç–‘çš„ç‰©å“ã€‚" }
            ],
            choices: [{ text: "å‰å¾€å»šæˆ¿æº–å‚™åˆé¤", next: "lunch_prep" }]
        },

        // --- Chapter 2 (BGM åˆ‡æ›ç‚º Tension) ---
        lunch_prep: {
            bg: "#3E2723", bgm: 'bgm_tension.mp3', clearScreen: true, title: "ç¬¬äºŒç« ï¼šå± å®°å ´",
            messages: [
                { sender: "system", text: "ä½ ä¾†åˆ°äº†å»šæˆ¿ã€‚é€™è£¡æ›æ»¿äº†è‚‰é‰¤ï¼Œé‰¤å­ä¸Šæ›è‘—ç©¿è‘—ç ´çˆ›è¥¿è£çš„ã€Œè‚‰å¡Šã€ã€‚" },
                { sender: "npc", name: "å± å¤«å»šå¸«", class: "chef", text: "è‚‰... æ–°é®®çš„è‚‰..." },
                { sender: "system", text: "ä¸€å€‹èº«é«˜å…©ç±³ã€æˆ´è‘—éµé¢å…·çš„ç”·äººæ­£åœ¨ç£¨åˆ€ã€‚ç«èŠ±å››æ¿ºã€‚" }
            ],
            choices: [
                { text: "è©¢å•ï¼šã€Œä»Šå¤©çš„åˆé¤æº–å‚™å¥½äº†å—ï¼Ÿã€", next: "kitchen_investigate" },
                { text: "è¶ä»–èƒŒå°æ™‚ï¼ŒæœæŸ¥æ—é‚Šçš„é«’è¡£ç±ƒ", next: "kitchen_search" }
            ]
        },
        kitchen_investigate: {
            bg: "#B71C1C",
            messages: [
                { sender: "npc", name: "å± å¤«å»šå¸«", class: "chef", text: "é‚„å·®ä¸€é»... ä½æ–™ä¸å¤ ..." },
                { sender: "system", text: "ä»–çŒ›ç„¶è½‰èº«ï¼Œæ‰‹è£¡çš„èœåˆ€ç›´æŒ‡ä½ çš„çœ‰å¿ƒã€‚" },
                { sender: "npc", name: "å± å¤«å»šå¸«", class: "chef", text: "ä½ çš„çœ¼ç ï¼Œçœ‹èµ·ä¾†å¾ˆé©åˆç‡‰æ¹¯ã€‚" }
            ],
            choices: [
                { text: "å†·éœå›æ‡‰ï¼šã€Œé€™æ˜¯åœ’é•·çš„ç‰¹æ¬Šï¼Œä½ ä¸èƒ½å‹•ã€‚ã€", next: "lunch_service" },
                { text: "å°–å«é€ƒè·‘", next: "bad_end_chef" } 
            ]
        },
        kitchen_search: {
            bg: "#4E342E",
            effect: () => { gameState.hasKitchenKey = true; }, // å„²è—å®¤é‘°åŒ™
            messages: [
                { sender: "system", text: "ä½ è¶å»šå¸«ä¸æ³¨æ„ï¼Œåœ¨é«’è¡£ç±ƒè£¡ç™¼ç¾ä¸€æŠŠç”Ÿé½çš„é‘°åŒ™ã€‚ä¸Šé¢æ¨™ç±¤å¯«è‘—ï¼šã€Œå„²è—å®¤ã€ã€‚" },
                { sender: "player", text: "ï¼ˆé€™å°±æ˜¯é‚£æŠŠã€ç”Ÿé½çš„é‘°åŒ™ã€ã€‚ï¼‰" }
            ],
            choices: [{ text: "å°‡é‘°åŒ™è—å¥½ï¼Œå‡è£å·¡è¦–", next: "lunch_service" }]
        },

        // --- Chapter 3 ---
        lunch_service: {
            bg: "#212121", title: "ç¬¬ä¸‰ç« ï¼šè–é¤", textColor: "#FFF",
            messages: [
                { sender: "system", text: "æ­£åˆåäºŒé»ã€‚é¤å»³è£¡æ­»ä¸€èˆ¬å¯‚éœã€‚" },
                { sender: "system", text: "ç›¤å­è£¡ç››è‘—é®®ç´…è‰²çš„è‚‰å¡Šï¼Œé‚„åœ¨å¾®å¾®è·³å‹•ã€‚" },
                { sender: "npc", name: "åŠ©æ‰‹å°æ—", class: "kobayashi", text: "åœ’é•·ï¼Œç‚ºäº†è­‰æ˜æ‚¨æ˜¯æˆ‘å€‘çš„ã€Œå®¶äººã€ï¼Œè«‹æ‚¨å…ˆå‹•å£ã€‚" }
            ],
            choices: [
                { text: "ã€Œæˆ‘æ—©å·²åƒéäº†ã€‚ã€(éœ€æŒæœ‰å®ˆå‰‡)", check: () => gameState.hasRuleBook, next: "survive_lunch" },
                { text: "åƒä¸‹é‚£å¡Šè‚‰", next: "bad_end_eat" },
                { text: "æ¨é–‹ç›¤å­ï¼šã€Œæˆ‘ä¸é¤“ã€‚ã€", next: "bad_end_refuse" }
            ]
        },
        
        // --- é‘°åŒ™ä½¿ç”¨åˆ†æ­§é» ---
        survive_lunch: {
            bg: "#1A237E",
            messages: [
                { sender: "npc", name: "åŠ©æ‰‹å°æ—", class: "kobayashi", text: "åˆ‡... çœŸå¯æƒœã€‚è«‹å…è¨±æˆ‘å»å·¡æŸ¥èµ°å»Šï¼Œé˜²æ­¢æœ‰ã€Œå®¢äººã€äº‚è·‘ã€‚" },
                { sender: "system", text: "å­©å­å€‘é–‹å§‹é€²é£Ÿã€‚ä½ ç²å¾—äº†çŸ­æš«çš„è‡ªç”±ã€‚ä½ è©²å»å“ªè£¡ï¼Ÿ" }
            ],
            choices: [
                { text: "æ½›å…¥åœ–æ›¸å®¤ (ä¸»è¦é€ƒç”Ÿè·¯å¾‘)", next: "hallway_qte_check" },
                { text: "ä½¿ç”¨å…’ç«¥å„²ç‰©æ«ƒé‘°åŒ™ (éœ€æŒæœ‰)", check: () => gameState.hasLockerKey, next: "use_locker_key" },
                { text: "æ½›å…¥å„²è—å®¤ (éœ€æŒæœ‰å„²è—å®¤é‘°åŒ™)", check: () => gameState.hasKitchenKey, next: "go_to_storage" }
            ]
        },
        
        // --- å…’ç«¥å„²ç‰©æ«ƒé‘°åŒ™ (æ–°å¢æ•¸å­—é¸æ“‡é‚è¼¯) ---
        use_locker_key: {
            bg: "#5D4037",
            messages: [
                { sender: "system", text: "ä½ å›åˆ°æ•™å®¤ã€‚é€™æŠŠé‘°åŒ™èƒ½æ‰“é–‹å­©å­å€‘çš„å„²ç‰©æ«ƒã€‚ä½ å›æƒ³èµ·åœ¨èª¿æŸ¥è¾¦å…¬å®¤æ™‚ç²å¾—çš„é—œéµæ•¸å­—..." },
                { sender: "system", text: "é¸æ“‡ä½ èªç‚ºæ­£ç¢ºçš„å„²ç‰©æ«ƒè™Ÿç¢¼ï¼š" }
            ],
            choices: [
                { text: "å„²ç‰©æ«ƒ 2", next: "bad_end_locker_fail" },
                { text: "å„²ç‰©æ«ƒ 21", next: "bad_end_locker_fail" },
                { text: "å„²ç‰©æ«ƒ 22", next: "locker_success" }, // Correct
                { text: "å„²ç‰©æ«ƒ 32", next: "bad_end_locker_fail" }
            ]
        },
        
        // æ­£ç¢ºæ‰“é–‹å„²ç‰©æ«ƒ 22
        locker_success: {
            bg: "#5D4037",
            effect: () => { gameState.hasMapFragment = true; },
            messages: [
                { sender: "system", text: "ä½ æ‰“é–‹äº†ç·¨è™Ÿ 22 çš„å„²ç‰©æ«ƒã€‚è£¡é¢ä¸æ˜¯ç©å…·ï¼Œè€Œæ˜¯ä¸€å¼µæ½¦è‰çš„åœ°åœ–ï¼Œæ¨™è¨»äº†å¾é¤å»³åˆ°åœ–æ›¸å®¤ä¹‹é–“çš„<span class='text-red'>æ‰€æœ‰é¬†å‹•åœ°æ¿</span>çš„ä½ç½®ã€‚" },
                { sender: "system", text: "ã€é“å…·ï¼šåœ°åœ–ç¢ç‰‡å·²ç²å¾—ã€‚ä½ ç¾åœ¨èƒ½é¿é–‹èµ°å»Šçš„é™·é˜±ã€‚ã€‘" }
            ],
            choices: [{ text: "å‰å¾€åœ–æ›¸å®¤", next: "post_hall_check" }] 
        },

        // --- å„²è—å®¤é‘°åŒ™ (é«˜é¢¨éšªè·¯å¾‘) ---
        go_to_storage: {
            bg: "#1a1a1a", sfx: 'sfx_door.mp3', textColor: "#CCC",
            messages: [
                { sender: "system", text: "ä½ æ‰“é–‹äº†å„²è—å®¤çš„é–€ï¼Œè£¡é¢å……æ»¿äº†è¡€è…¥å‘³å’Œè¢«è‚¢è§£çš„è‚‰å¡Šã€‚ä½ çœ‹åˆ°è§’è½èººè‘—ä¸€æŠŠ**éµæ’¬**ã€‚" }
            ],
            choices: [{ text: "æ’¿èµ·éµæ’¬ (é«˜é¢¨éšª)", next: "storage_qte" }]
        },
        storage_qte: {
            bg: "#1a1a1a",
            effect: () => { 
                gameState.hasCrowbar = true; 
                const targetKey = 'S'; // å‘å¾Œå¿«é€Ÿé€€é–‹
                startQTE(targetKey, 1500, "storage_success", "bad_end_chef", isMobile ? "å¿«é€Ÿé»æ“Šï¼Œé–ƒé¿æ”»æ“Šï¼" : "å‰›æ’¿èµ·éµæ’¬ï¼Œå± å¤«å»šå¸«å¾é–€å£å‡ºç¾ï¼å¿«é€ŸæŒ‰ä¸‹ S é–ƒé¿ï¼"); 
            },
            messages: [
                { sender: "system", text: "ä½ å‰›æ¡ä½éµæ’¬ï¼Œèº«å¾ŒéŸ¿èµ·äº†æ²‰é‡çš„è…³æ­¥è²ï¼" }
            ],
            choices: []
        },
        storage_success: {
            bg: "#212121", textColor: "#FFF",
            messages: [
                { sender: "system", text: "ä½ æˆåŠŸå‘å¾Œé–ƒé–‹ï¼Œå± å¤«å»šå¸«çš„å·¨åˆƒç åœ¨äº†ç‰†ä¸Šã€‚" },
                { sender: "system", text: "ã€é“å…·ï¼šéµæ’¬å·²ç²å¾—ã€‚ã€‘ä½ è¶ä»–æ‹”åˆ€æ™‚ï¼Œå€‰çš‡è·‘å‡ºå„²è—å®¤ã€‚" }
            ],
            choices: [{ text: "å‰å¾€åœ–æ›¸å®¤ (ç¹éèµ°å»Š)", next: "hallway_qte" }] // ç„¡åœ°åœ–ï¼Œä»ç„¶è¦éèµ°å»Š QTE
        },
        
        // --- èµ°å»Š QTE æª¢æŸ¥é» ---
        hallway_qte_check: {
            messages: [],
            effect: () => {
                if (gameState.hasMapFragment) {
                    renderScene('post_hall_check');
                } else {
                    renderScene('hallway_qte');
                }
            },
            choices: []
        },

        hallway_qte: {
            bg: "#455A64",
            messages: [
                { sender: "system", text: "èµ°å»Šçš„æœ¨æ¿ç™¼å‡ºå°–éŠ³çš„å˜å±è²ï¼ä½ æ„Ÿè¦ºåˆ°èº«å¾Œæœ‰ä»€éº¼æ±è¥¿æ­£è¿…é€Ÿé è¿‘..." },
                { sender: "system", text: isMobile ? "ã€ğŸš¨ ç·Šæ€¥ï¼šå¿«é€Ÿé»æ“Šç•«é¢ä»¥ç©©å®šè…³æ­¥ï¼ ğŸš¨ã€‘" : "ã€ğŸš¨ ç·Šæ€¥ï¼šå¿«é€ŸæŒ‰ä¸‹ A æˆ– D ä»¥ç©©å®šè…³æ­¥ï¼ ğŸš¨ã€‘" }
            ],
            choices: [
                { text: "ç©©å®šè…³æ­¥ï¼Œé¿å…ç™¼å‡ºè²éŸ³", next: "start_qte_1" }
            ]
        },
        start_qte_1: {
            effect: () => {
                const keys = ['A', 'D'];
                const targetKey = keys[Math.floor(Math.random() * keys.length)];
                startQTE(targetKey, 2000, "post_hall_check", "bad_end_refuse", isMobile ? "å¿«é€Ÿé»æ“Šç•«é¢ï¼Œç©©ä½è…³æ­¥ï¼" : "å¿«é€ŸæŒ‰ä¸‹æŒ‰éµï¼Œç©©ä½è…³æ­¥ï¼"); 
            },
            messages: [{ sender: "system", text: "ç·Šæ€¥æ‡‰è®Šå•Ÿå‹•ä¸­..." }],
            choices: []
        },

        // --- NEWï¼šå®ˆå‰‡ 3 (ç¬‘è²) æª¢æŸ¥é» ---
        post_hall_check: {
            messages: [],
            effect: () => {
                // å¦‚æœæœ‰å®ˆå‰‡ï¼Œå‰‡å¿…é ˆé¢å°ç¬‘è² QTE
                if (gameState.hasRuleBook) {
                    renderScene('laughter_check');
                } else {
                    // æ²’æœ‰å®ˆå‰‡ï¼Œç›´æ¥é€²å…¥åœ–æ›¸å®¤
                    renderScene('library_puzzle'); 
                }
            },
            choices: []
        },

        // NEW LAUGHTER QTE SCENE (Rule 3)
        laughter_check: {
            bg: "#455A64",
            sfx: 'sfx_tension.mp3', // ç¹¼çºŒä½¿ç”¨ç·Šå¼µéŸ³æ•ˆä¾†æ¨¡æ“¬è©­ç•°çš„ç¬‘è²
            messages: [
                { sender: "system", text: "ä½ ç©¿éèµ°å»Šï¼Œèº«å¾Œå‚³ä¾†äº†ä¸€é™£æ‰­æ›²çš„ã€åˆºè€³çš„å­©ç«¥<span class='text-red'>å¬‰ç¬‘è²</span>ï¼" },
                { sender: "system", text: "ï¼ˆå®ˆå‰‡ 3ï¼šå¦‚æœè½åˆ°ç¬‘è²ï¼Œ<span class='text-red'>ä¸è¦å›é ­</span>ï¼ï¼‰" },
                { sender: "system", text: isMobile ? "ã€ğŸš¨ ç·Šæ€¥ï¼šå¿«é€Ÿé»æ“Šç•«é¢ï¼Œä¿æŒé¢å‘å‰æ–¹ï¼ ğŸš¨ã€‘" : "ã€ğŸš¨ ç·Šæ€¥ï¼šå¿«é€ŸæŒ‰ä¸‹ S éµï¼Œä¿æŒé¢å‘å‰æ–¹ï¼ ğŸš¨ã€‘" }
            ],
            choices: [
                { text: "ç¹¼çºŒå‰é€²ï¼Œä¸å›é ­", next: "start_qte_laughter" }
            ]
        },
        start_qte_laughter: {
            effect: () => {
                const targetKey = 'S'; 
                startQTE(targetKey, 1700, "library_puzzle", "bad_end_laughter", isMobile ? "å¿«é€Ÿé»æ“Šï¼Œä¸è¦å›é ­ï¼" : "å¿«é€ŸæŒ‰ä¸‹ Sï¼Œä¸è¦å›é ­ï¼"); 
            },
            messages: [{ sender: "system", text: "ç·Šæ€¥æ‡‰è®Šå•Ÿå‹•ä¸­..." }],
            choices: []
        },
        // --- End Rule 3 Check ---


        // --- Chapter 4 ---
        library_puzzle: {
            bg: "#0D47A1", clearScreen: true, title: "ç¬¬å››ç« ï¼šç¦å€",
            messages: [
                { sender: "system", text: "ä½ å®‰å…¨åœ°é€²å…¥äº†åœ–æ›¸å®¤ã€‚æˆ¿é–“ä¸­å¤®æœ‰ä¸€é¢å·¨å¤§çš„è½åœ°é¡ï¼Œç‰†ä¸Šæ›è‘—ä¸€å¼µæ³›é»ƒçš„ç´™æ¢ã€‚" }
            ],
            choices: [
                { text: "æŠ¬é ­çœ‹å‘é¡ä¸­çš„è‡ªå·± (é•åå®ˆå‰‡)", next: "bad_end_mirror" },
                { text: "ä½é ­è¨ˆç®—å¯†ç¢¼ (éœ€æŒæœ‰å®ˆå‰‡)", check: () => gameState.hasRuleBook, next: "code_guess" },
                { text: "æ²’æœ‰å¯†ç¢¼ï¼Œç”¨éµæ’¬å¼·è¡Œç ´é–€ (éœ€æŒæœ‰éµæ’¬)", check: () => gameState.hasCrowbar, next: "bad_end_crowbar_break" },
                { text: "æ²’æœ‰é‘°åŒ™/å¯†ç¢¼ï¼Œåªèƒ½ç¡¬é—–é€ƒç”Ÿé–€", check: () => !gameState.hasLibraryCode && !gameState.hasCrowbar, next: "bad_end_refuse" }
            ]
        },
        code_guess: {
            bg: "#0D47A1",
            messages: [
                { sender: "system", text: "ä½ è½‰å‹•äº†é¡å­ï¼Œç™¼ç¾èƒŒå¾Œå¯«è‘—ï¼šã€è‚‰å¡Š = 7ã€ã€‚å¯†ç¢¼æ˜¯ 15 + 7 = 22ã€‚ä½ è¨˜ä½äº†å¯†ç¢¼ã€‚" },
                { sender: "system", text: "ï¼ˆå®ˆå‰‡ 4ï¼šä½ é¿é–‹äº†é¡å­...ï¼‰" }
            ],
            effect: () => { gameState.hasLibraryCode = true; }, 
            choices: [{ text: "å‰å¾€åˆç¡å®¤ï¼Œæº–å‚™é€ƒè„«", next: "nap_time_qte" }] 
        },

        // éµæ’¬ç ´é–€çš„å£çµå±€
        bad_end_crowbar_break: {
            bg: "#8B0000", sfx: 'sfx_jumpscare.mp3', textColor: "#FFF",
            messages: [
                { sender: "system", text: "ä½ ç”¨éµæ’¬é–‹å§‹æ’¬å‹•é€ƒç”Ÿé–€ã€‚å·¨å¤§çš„å™ªéŸ³å‚³éäº†æ•´å€‹å¹¼ç¨šåœ’ã€‚" },
                { sender: "system", text: "åœ¨é–€é–è¢«æ’¬é–‹å‰ä¸€ç§’ï¼Œä½ è½è¦‹èµ°å»Šå‚³ä¾†äº†æ¥µé€Ÿå¥”è·‘çš„è²éŸ³â€”â€”æ˜¯å°æ—ã€‚" },
                { sender: "npc", name: "åŠ©æ‰‹å°æ—", class: "kobayashi", text: "åµæ­»äº†ï¼æˆ‘ä»¥ç‚ºä½ æ˜¯å€‹å®‰éœçš„é£Ÿç‰©ï¼" },
                { sender: "system", text: "ã€çµå±€ 8ï¼šå™ªéŸ³å¼•ä¾†çš„ç½é›£ã€‘" }
            ],
            choices: [{ text: "é‡æ–°è¼ªè¿´", next: "start" }] 
        },

        // --- çµ‚ç«  ---
        nap_time_qte: {
            bg: "#000000", bgm: 'bgm_tension.mp3', clearScreen: true, title: "çµ‚ç« ï¼šç”Ÿèˆ‡æ­»", textColor: "#CCC",
            messages: [
                { sender: "system", text: "åˆç¡å®¤è£¡æ­»å¯‚ä¸€ç‰‡ã€‚åŠ©æ‰‹å°æ—æ­£æœé€™è£¡èµ°ä¾†ï¼" },
                { sender: "system", text: isMobile ? "ã€ğŸš¨ ç·Šæ€¥ï¼šå¿«é€Ÿé»æ“Šç•«é¢ä»¥èº²å…¥æ«ƒå­ï¼ ğŸš¨ã€‘" : "ã€ğŸš¨ ç·Šæ€¥ï¼šå¿«é€ŸæŒ‰ä¸‹ W ä»¥èº²å…¥æ«ƒå­ï¼ ğŸš¨ã€‘" }
            ],
            choices: [{ text: "å±ä½å‘¼å¸ï¼Œè¿…é€Ÿèº²è—", next: "start_qte_2" }]
        },
        start_qte_2: {
            effect: () => {
                const targetKey = 'W'; 
                startQTE(targetKey, 1700, "nap_time_success", "bad_end_refuse", isMobile ? "å¿«é€Ÿé»æ“Šç•«é¢ï¼Œèº²è—ï¼" : "å¿«é€ŸæŒ‰ä¸‹ Wï¼Œèº²è—ï¼"); 
            },
            messages: [{ sender: "system", text: "ç·Šæ€¥æ‡‰è®Šå•Ÿå‹•ä¸­..." }],
            choices: []
        },
        nap_time_success: {
            bg: "#000000", textColor: "#CCC",
            messages: [
                { sender: "system", text: "ä½ æˆåŠŸèº²å…¥äº†è¡£æ«ƒï¼Œå°æ—å¾ä½ èº«é‚Šèµ°éï¼Œæ²’æœ‰å¯Ÿè¦ºã€‚ç¾åœ¨æ˜¯è¼¸å…¥å¯†ç¢¼çš„æ©Ÿæœƒï¼" }
            ],
            choices: [
                { text: "è¼¸å…¥å¯†ç¢¼ 22 é€ƒé›¢", check: () => gameState.hasLibraryCode, next: "good_end_escape" },
                { text: "æ²’æœ‰å¯†ç¢¼ï¼Œå˜—è©¦ç¡¬é–‹é–€", check: () => !gameState.hasLibraryCode, next: "bad_end_refuse" }
            ]
        },
        
        // --- çµå±€é›† ---
        bad_end_early_feed: { bg: "#000000", sfx: 'sfx_jumpscare.mp3', textColor: "#F00", messages: [ { sender: "system", text: "ä½ ä¸è©²å•é€™å€‹å•é¡Œçš„ã€‚" }, { sender: "npc", name: "å­©å­å€‘", class: "children", text: "é¤“äº†... é¤“äº†ï¼ï¼ï¼" }, { sender: "system", text: "ã€çµå±€ 1ï¼šé£¯å‰é»å¿ƒã€‘" } ], choices: [{ text: "é‡æ–°è¼ªè¿´", next: "start" }] },
        bad_end_panic: { bg: "#8B0000", sfx: 'sfx_jumpscare.mp3', textColor: "#FFF", messages: [ { sender: "system", text: "ææ‡¼çš„å‘³é“æ˜¯è—ä¸ä½çš„ã€‚" }, { sender: "npc", name: "åŠ©æ‰‹å°æ—", class: "kobayashi", text: "å•Š... åŸä¾†æ˜¯è„†å¼±çš„äººé¡å•Šã€‚" }, { sender: "system", text: "ã€çµå±€ 2ï¼šå½è£å¤±æ•—ã€‘" } ], choices: [{ text: "é‡æ–°è¼ªè¿´", next: "start" }] },
        bad_end_chef: { bg: "#3E2723", textColor: "#FFF", messages: [ { sender: "system", text: "ä½ ä¸è©²èƒŒå°ä¸€å€‹å± å¤«ã€‚" }, { sender: "system", text: "å†°å†·çš„åˆ€é‹’å¾å¾Œé ¸åˆ‡å…¥ï¼Œä½ çš„è¦–ç·šæ—‹è½‰è‘—é£›äº†å‡ºå»ã€‚" }, { sender: "system", text: "ã€çµå±€ 3ï¼šå»šæˆ¿æ„å¤–ã€‘" } ], choices: [{ text: "é‡æ–°è¼ªè¿´", next: "start" }] },
        bad_end_eat: { bg: "#4A148C", textColor: "#FFF", messages: [ { sender: "system", text: "è‚‰å¡Šæ»‘å…¥å–‰åš¨ï¼Œç•°å¸¸é®®ç¾ã€‚ä½ æ„Ÿè¦ºèº«é«”è£¡çš„æŸå€‹é–‹é—œè¢«æ‰“é–‹äº†ã€‚" }, { sender: "player", text: "ã€Œé‚„è¦... æ›´å¤š...ã€" }, { sender: "system", text: "ã€çµå±€ 4ï¼šåŒåŒ–ã€‘" } ], choices: [{ text: "é‡æ–°è¼ªè¿´", next: "start" }] },
        bad_end_refuse: { bg: "#000000", sfx: 'sfx_jumpscare.mp3', textColor: "#F00", messages: [ { sender: "system", text: "ä½ æ²’æœ‰é€šéæœ€çµ‚è€ƒé©—ï¼Œæˆ–è€…å‹•ä½œä¸å¤ å¿«ã€‚" }, { sender: "npc", name: "æ€ªç‰©å€‘", class: "children", text: "ä»–è¢«æŠ“ä½äº†... ä»–æ˜¯é£Ÿç‰©ï¼" }, { sender: "system", text: "ã€çµå±€ 5ï¼šä¸»èœã€‘" } ], choices: [{ text: "é‡æ–°è¼ªè¿´", next: "start" }] },
        bad_end_mirror: { bg: "#FFFFFF", sfx: 'sfx_jumpscare.mp3', textColor: "#8b0000", messages: [ { sender: "system", text: "ä½ çœ‹åˆ°é¡å­è£¡çš„è‡ªå·±è£‚é–‹äº†ï¼Œç„¡æ•¸çœ¼ç›åœ¨é»‘è‰²çš„è¡€è‚‰ä¸­æ™æ‰ã€‚" }, { sender: "system", text: "ã€çµå±€ 6ï¼šé¡åƒè©›å’’ã€‘" } ], choices: [{ text: "é‡æ–°è¼ªè¿´", next: "start" }] },
        good_end_escape: { bg: "#FFFFFF", textColor: "#000", messages: [ { sender: "system", text: "ä½ è¼¸å…¥äº†å¯†ç¢¼ 22ã€‚é›»å­é–ç™¼å‡ºå’”å™ è²ï¼Œå¾Œé–€é–‹å•Ÿã€‚" }, { sender: "system", text: "ä½ è¡å‡ºå¾Œé–€ï¼Œå¤–é¢çš„ä¸–ç•Œæ˜¯ä¸€ç‰‡è’è•ªçš„å»¢å¢Ÿã€‚" }, { sender: "system", text: "ã€çµå±€ 7ï¼šå€–å­˜è€…ã€‘(True End)" } ], choices: [{ text: "é‡æ–°é–‹å§‹éŠæˆ²", next: "start" }] },
        
        bad_end_laughter: { 
            bg: "#8B0000", 
            sfx: 'sfx_jumpscare.mp3', 
            textColor: "#FFF", 
            messages: [ 
                { sender: "system", text: "ä½ å¿ä¸ä½å›é ­çœ‹äº†ä¸€çœ¼ã€‚" }, 
                { sender: "system", text: "é‚£ä¸æ˜¯å­©å­ï¼Œé‚£æ˜¯ä¸€åœ˜ç”±è¡€è‚‰å’Œé‹¼çµ²çµ„æˆçš„å·¨å‹èœ˜è››ï¼Œå®ƒçš„è…¹éƒ¨ä¸æ–·ç™¼å‡ºå°–éŠ³çš„ç¬‘è²..." }, 
                { sender: "system", text: "ã€çµå±€ 9ï¼šå›é ­æ˜¯å²¸ã€‘" } 
            ], 
            choices: [{ text: "é‡æ–°è¼ªè¿´", next: "start" }] 
        },

        bad_end_locker_fail: { 
            bg: "#8B0000", 
            sfx: 'sfx_jumpscare.mp3', 
            textColor: "#FFF", 
            messages: [ 
                { sender: "system", text: "ä½ ç”¨é‘°åŒ™æ‰“é–‹äº†éŒ¯èª¤çš„å„²ç‰©æ«ƒã€‚æ«ƒé–€å¾Œå½ˆå‡ºä¸€å€‹è£æ»¿å°–åˆºçš„éµç± ï¼Œå°‡ä½ å£“åœ¨ç‰†ä¸Šï¼" }, 
                { sender: "system", text: "å°–å«è²å¼•ä¾†äº†æ­£åœ¨é¤å»³é€²é£Ÿçš„å­©å­å€‘ã€‚" }, 
                { sender: "npc", name: "å­©å­å€‘", class: "children", text: "é‚„æœ‰ç”œé»ï¼" },
                { sender: "system", text: "ã€çµå±€ 10ï¼šéŒ¯èª¤çš„é¸æ“‡ã€‘" } 
            ], 
            choices: [{ text: "é‡æ–°è¼ªè¿´", next: "start" }] 
        },
        
        // NEW BAD ENDING - è¾¦å…¬å®¤é¡å­
        bad_end_office_mirror: { 
            bg: "#FFFFFF", 
            sfx: 'sfx_jumpscare.mp3', 
            textColor: "#8b0000", 
            messages: [ 
                { sender: "system", text: "ä½ æŠ¬é ­çœ‹å‘ç‰†ä¸Šçš„é¡å­ã€‚é¡ä¸­çš„ä½ è£‚é–‹äº†ï¼Œç„¡æ•¸è •å‹•çš„é»‘è‰²è‚¢é«”æ­£åœ¨å¾è£‚ç¸«ä¸­ä¼¸å‡ºï¼Œå°‡ä½ çš„è‡‰å­”æ‰­æ›²ã€‚" }, 
                { sender: "system", text: "ä½ æ‡‰è©²è¨˜å¾—å®ˆå‰‡ 4 çš„è­¦å‘Š..." },
                { sender: "npc", name: "é–€å¤–çš„è²éŸ³", class: "kobayashi", text: "å’¦ï¼Ÿåœ’é•·æ€éº¼é€™éº¼å¿«å°±å£æ‰äº†ï¼Ÿ" },
                { sender: "system", text: "ã€çµå±€ 11ï¼šé¡åƒå•Ÿå‹•ã€‘" } 
            ], 
            choices: [{ text: "é‡æ–°è¼ªè¿´", next: "start" }] 
        },

    };

    // --- æ ¸å¿ƒæ¸²æŸ“é‚è¼¯ ---
    const logArea = document.getElementById('log-area');
    const controlsArea = document.getElementById('controls-area');
    const headerTitle = document.getElementById('header-title');
    const bodyElement = document.body;
    const startScreen = document.getElementById('start-screen');

    async function typeWriter(element, text, speed = 20) {
        return new Promise(resolve => {
            let i = 0;
            function type() {
                if (i < text.length) {
                    // Check for HTML tag start (for <span class='text-red'>...</span>)
                    if(text.charAt(i) === '<') {
                        let tag = '';
                        let tagStart = i;
                        // Fast forward through the tag
                        while(text.charAt(i) !== '>' && i < text.length) {
                            tag += text.charAt(i);
                            i++;
                        }
                        if (i < text.length) {
                            tag += '>';
                            i++;
                        }
                        // Append the tag without typing delay
                        element.innerHTML = text.substring(0, i);
                    } else {
                        // Regular character typing
                        i++;
                        element.innerHTML = text.substring(0, i);
                        
                    }
                    // æ»¾å‹•åˆ°åº•éƒ¨
                    setTimeout(type, speed);
                    logArea.scrollTop = logArea.scrollHeight;
                } else {
                    resolve();
                }
            }
            type();
        });
    }


    function isColorDark(colorCode) {
        const hex = colorCode.replace('#', '');
        // åˆ¤æ–·é¡è‰²æ˜¯å¦ç‚ºæ·±è‰²ç³»
        const darks = ["000000", "212121", "B71C1C", "37474F", "4A148C", "3E2723", "1A237E", "8B0000", "455A64"];
        return darks.includes(hex.toUpperCase());
    }
    
    async function renderScene(sceneId) {
        
        const scene = story[sceneId];
        
        if (scene.bgm) { playBGM(scene.bgm); } 
        if (scene.sfx) { stopBGM(); playSFX(scene.sfx); } else if (sceneId.startsWith('bad_end')) { stopBGM(); playSFX('sfx_jumpscare.mp3'); }
        
        if(sceneId === 'start') { resetGame(); playBGM('bgm_mystery.mp3'); }
        
        if(scene.effect) scene.effect();

        if(scene.clearScreen) {
            logArea.innerHTML = '';
            if(scene.title) {
                const titleDiv = document.createElement('div');
                titleDiv.style.textAlign = 'center';
                titleDiv.style.margin = '20px auto';
                titleDiv.style.background = 'var(--box-bg)'; 
                titleDiv.style.border = '1px solid var(--border-light)';
                titleDiv.style.padding = '8px 15px'; 
                titleDiv.style.fontWeight = '600';
                titleDiv.style.letterSpacing = '1px';
                titleDiv.style.maxWidth = '300px';
                titleDiv.style.color = 'var(--accent-color)';
                titleDiv.innerText = `${scene.title}`;
                titleDiv.style.borderRadius = '4px';
                logArea.appendChild(titleDiv);
            }
        }

        // è¨­ç½®ä¸»é¡Œé¡è‰²
        bodyElement.style.backgroundColor = scene.bg;
        const isDark = isColorDark(scene.bg);
        bodyElement.setAttribute('data-theme', isDark ? 'dark' : 'light');

        controlsArea.innerHTML = ''; 

        for (let msg of scene.messages) {
            const msgDiv = document.createElement('div');
            msgDiv.classList.add('message');
            
            if (msg.sender === 'system') {
                msgDiv.classList.add('system');
            } else if (msg.sender === 'player') {
                msgDiv.classList.add('player');
            } else {
                msgDiv.classList.add('npc');
                msgDiv.setAttribute('data-sender', msg.name);
                if (msg.class) {
                    msgDiv.classList.add(msg.class);
                }
            }
            
            logArea.appendChild(msgDiv);
            await typeWriter(msgDiv, msg.text);
            await new Promise(r => setTimeout(r, 400));
        }
        
        // æ¸²æŸ“æŒ‰éˆ•
        if (!sceneId.startsWith('start_qte')) {
            scene.choices.forEach(choice => {
                if (choice.check && !choice.check()) return;
                const btn = document.createElement('button');
                btn.innerHTML = choice.text;
                btn.onclick = () => renderScene(choice.next);
                controlsArea.appendChild(btn);
            });
        }
    }

    window.onload = () => {
        // è™•ç†æ‰‹æ©Ÿä¸Šçš„éŸ³è¨Šæ’­æ”¾é™åˆ¶
        startScreen.onclick = () => {
            startScreen.style.opacity = '0';
            setTimeout(() => {
                startScreen.style.display = 'none';
                renderScene('start');
            }, 1000); 
        };
    };

</script>

</body>
</html>